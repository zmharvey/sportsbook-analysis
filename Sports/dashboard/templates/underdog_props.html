{% extends "base.html" %}

{% block title %}Underdog Props - Sports Betting Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="mb-1"><i class="bi bi-list-ul me-2" style="color: var(--warning);"></i>Underdog Props</h2>
        <p class="text-muted mb-0">All Underdog props with EV, sorted by fair probability â€” use this to pick profitable parlays</p>
    </div>
    <div class="col-auto">
        <span class="refresh-indicator">
            <span class="spinner-border spinner-border-sm d-none" id="refresh-spinner"></span>
            Auto-refreshes every 30s
        </span>
    </div>
</div>

<!-- Props Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-plays table-hover mb-0">
            <thead>
                <tr>
                    <th>Fair Prob</th>
                    <th>EV</th>
                    <th>Sport</th>
                    <th>Game</th>
                    <th>Player</th>
                    <th>Prop</th>
                    <th>Outcome</th>
                    <th>Line</th>
                    <th>Underdog Odds</th>
                    <th>Sharp Odds</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="props-table-body">
                <tr>
                    <td colspan="11" class="text-center py-5">
                        <div class="spinner-border" role="status" style="color: var(--primary-light);"></div>
                        <p class="mt-3 text-muted mb-0">Loading Underdog props...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="no-props-message" class="text-center py-5 d-none">
    <i class="bi bi-inbox" style="font-size: 4rem; color: var(--text-muted); opacity: 0.3;"></i>
    <p class="mt-3 text-muted mb-0">No Underdog props found</p>
    <p class="text-muted small">No Underdog props available at this time</p>
</div>
{% endblock %}

{% block scripts %}
<script>
const utils = dashboardUtils;

// Prop type display names
const propTypeNames = {
    'player_points': 'Points',
    'player_rebounds': 'Rebounds',
    'player_assists': 'Assists',
    'player_threes': '3-Pointers',
    'player_points_rebounds_assists': 'PRA',
    'player_pass_yds': 'Pass Yds',
    'player_rush_yds': 'Rush Yds',
    'player_reception_yds': 'Rec Yds',
    'player_receptions': 'Receptions',
    'player_anytime_td': 'Anytime TD',
    'batter_hits': 'Hits',
    'pitcher_strikeouts': 'Strikeouts',
    'player_goals': 'Goals',
    'player_shots_on_goal': 'SOG',
    'player_total_shots': 'Total Shots',
    'player_total_tackles': 'Tackles',
    'player_total_cards': 'Cards',
    'player_goal_scorer_anytime': 'Anytime Scorer',
};

function formatPropType(propType) {
    return propTypeNames[propType] || propType?.replace('player_', '').replace('batter_', '').replace('pitcher_', '').replace(/_/g, ' ') || '';
}

document.addEventListener('DOMContentLoaded', function() {
    loadUnderdogProps();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadUnderdogProps();
    }, 30000);
});

async function loadUnderdogProps() {
    try {
        const spinner = document.getElementById('refresh-spinner');
        spinner?.classList.remove('d-none');
        
        const response = await fetch('/api/underdog-props');
        const props = await response.json();

        const tbody = document.getElementById('props-table-body');
        const noPropsMsg = document.getElementById('no-props-message');

        if (props.length === 0) {
            tbody.innerHTML = '';
            noPropsMsg.classList.remove('d-none');
        } else {
            noPropsMsg.classList.add('d-none');

            tbody.innerHTML = props.map(prop => {
                const fairProb = prop.fair_prob * 100;
                const ev = prop.ev;
                const evClass = ev >= 5 ? 'ev-high' :
                               ev >= 1 ? 'ev-positive' :
                               ev >= 0 ? '' : 'text-danger';
                
                const underdogOddsClass = prop.underdog_odds_american > 0 ? 'positive-odds' : 'negative-odds';
                const sharpOddsClass = prop.sharp_odds_american > 0 ? 'positive-odds' : 'negative-odds';
                
                const propName = formatPropType(prop.prop_type);
                const graphLink = `/prop-graph/${prop.event_id}?player=${encodeURIComponent(prop.player_name)}&prop_type=${prop.prop_type}&line=${prop.line}`;

                return `
                    <tr>
                        <td class="fw-semibold">${fairProb.toFixed(1)}%</td>
                        <td class="${evClass} fw-semibold">${ev >= 0 ? '+' : ''}${ev.toFixed(2)}%</td>
                        <td><span class="badge bg-dark badge-sport">${utils.getSportName(prop.sport)}</span></td>
                        <td class="small">${prop.away_team} @ ${prop.home_team}</td>
                        <td><strong class="player-name">${prop.player_name}</strong></td>
                        <td class="small">${propName}</td>
                        <td><span class="badge ${prop.outcome === 'Over' ? 'bg-success' : 'bg-danger'}">${prop.outcome}</span></td>
                        <td class="fw-semibold">${prop.line}</td>
                        <td class="odds ${underdogOddsClass}">${utils.formatOdds(prop.underdog_odds_american)}</td>
                        <td class="odds ${sharpOddsClass} small text-muted">${utils.formatOdds(prop.sharp_odds_american)}</td>
                        <td>
                            <a href="${graphLink}" class="btn btn-outline-secondary btn-sm py-0 px-2" title="View odds movement">
                                <i class="bi bi-graph-up"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');

            utils.updateLastUpdated();
        }
    } catch (e) {
        console.error('Failed to load Underdog props:', e);
        const tbody = document.getElementById('props-table-body');
        if (tbody) {
            utils.showError(tbody.parentElement.parentElement, 'Failed to load Underdog props');
        }
    } finally {
        const spinner = document.getElementById('refresh-spinner');
        spinner?.classList.add('d-none');
    }
}
</script>
{% endblock %}
